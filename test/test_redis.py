import redis
import pickle

class test_get_market_prices:
    def __init__(self, redis_host='localhost', redis_port=6379):
        
        self.redis_client = redis.StrictRedis(host=redis_host, port=redis_port)

    def get_market_prices(self):
        '''获取市场深度数据'''
        while True:
            message = self.redis_client.brpop('b-depth', timeout=5) #设置超时
            if message:
                
                data = pickle.loads(message[1])
                
                market_data = data['data'][0] 
                bids = market_data['bids']
                asks = market_data['asks']
                yield bids, asks
            else:
                break
{'stream': 'USDCUSDT@DEPTH20@1000MS', 
    'data': [{
    'bids': [['1.00010000', '18465103.00000000'], ['1.00000000', '23500970.00000000'], ['0.99990000', '860280.00000000'], ['0.99980000', '666233.00000000'], ['0.99970000', '1019148.00000000'], ['0.99960000', '1197559.00000000'], ['0.99950000', '586019.00000000'], ['0.99940000', '637233.00000000'], ['0.99930000', '289845.00000000'], ['0.99920000', '283645.00000000'], ['0.99910000', '62721.00000000'], ['0.99900000', '171937.00000000'], ['0.99890000', '2838.00000000'], ['0.99880000', '76964.00000000'], ['0.99870000', '282.00000000'], ['0.99860000', '21201.00000000'], ['0.99850000', '2258.00000000'], ['0.99840000', '423.00000000'], ['0.99830000', '260.00000000'], ['0.99820000', '165.00000000']],
    'asks': [['1.00020000', '20881060.00000000'], ['1.00030000', '9282201.00000000'], ['1.00040000', '3378409.00000000'], ['1.00050000', '1350806.00000000'], ['1.00060000', '95946.00000000'], ['1.00070000', '70256.00000000'], ['1.00080000', '188729.00000000'], ['1.00090000', '720650.00000000'], ['1.00100000', '88996.00000000'], ['1.00110000', '105966.00000000'], ['1.00120000', '71345.00000000'], ['1.00130000', '25613.00000000'], ['1.00140000', '102291.00000000'], ['1.00150000', '23190.00000000'], ['1.00160000', '23178.00000000'], ['1.00170000', '22637.00000000'], ['1.00180000', '70.00000000'], ['1.00190000', '8754.00000000'], ['1.00200000', '17814.00000000'], ['1.00210000', '36072.00000000']], 
    'cts': 1728991574479, 
    'ts': 1728991574479, 
    'instrument_id': 'USDCUSDT'}]}

if __name__ == "__main__":
    fetcher = test_get_market_prices()
    for bids, asks in fetcher.get_market_prices():
        print(f"Bids: {bids}, Asks: {asks}")